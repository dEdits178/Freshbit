generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  COMPANY
  COLLEGE
  ADMIN
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum DriveStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum StageName {
  APPLICATIONS
  TEST
  SHORTLIST
  INTERVIEW
  FINAL
}

enum StageStatus {
  NOT_STARTED
  ACTIVE
  COMPLETED
}

enum FileType {
  JD
  STUDENT_LIST
  SHORTLIST
  FINAL_LIST
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum ManagedBy {
  COLLEGE
  ADMIN
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  role      Role
  status    UserStatus
  verified  Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  company   Company?   @relation("UserCompany")
  college   College?   @relation("UserCollege")
  auditLogs AuditLog[]
  fileUploadsUploaded FileUpload[]
}

model Company {
  id        String   @id @default(uuid())
  name      String
  domain    String
  approved  Boolean
  userId    String   @unique
  user      User     @relation("UserCompany", fields: [userId], references: [id])
  drives    Drive[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model College {
  id            String         @id @default(uuid())
  name          String
  city          String
  state         String
  tier          String
  approved      Boolean
  userId        String         @unique
  user          User           @relation("UserCollege", fields: [userId], references: [id])
  driveColleges DriveCollege[]
  students      Student[]
  stages        DriveStage[]
  fileUploads   FileUpload[]
  driveStudents DriveStudent[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Drive {
  id            String         @id @default(uuid())
  companyId     String
  company       Company        @relation(fields: [companyId], references: [id])
  roleTitle     String
  salary        Int
  description   String
  status        DriveStatus
  jdFileUrl     String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  driveColleges DriveCollege[]
  applications  Application[]
  stages        DriveStage[]
  fileUploads   FileUpload[]
  driveStudents DriveStudent[]

  @@index([companyId])
  @@index([status])
}

model DriveCollege {
  id               String           @id @default(uuid())
  driveId          String
  collegeId        String
  invitationStatus InvitationStatus @default(PENDING)
  managedBy        ManagedBy?
  startedAt        DateTime?
  drive            Drive            @relation(fields: [driveId], references: [id])
  college          College          @relation(fields: [collegeId], references: [id])
  createdAt        DateTime         @default(now())

  @@unique([driveId, collegeId])
  @@index([driveId])
  @@index([collegeId])
}

model Student {
  id           String        @id @default(uuid())
  firstName    String
  lastName     String
  email        String
  phone        String?
  course       String?
  cgpa         Float?
  collegeId    String
  college      College       @relation(fields: [collegeId], references: [id])
  driveLinks   DriveStudent[]
  applications Application[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([email, collegeId])
  @@index([collegeId])
}

model DriveStudent {
  id         String   @id @default(uuid())
  driveId    String
  studentId  String
  collegeId  String
  drive      Drive    @relation(fields: [driveId], references: [id])
  student    Student  @relation(fields: [studentId], references: [id])
  college    College  @relation(fields: [collegeId], references: [id])
  createdAt  DateTime @default(now())

  @@unique([driveId, studentId])
}

model Application {
  id        String    @id @default(uuid())
  studentId String
  driveId   String
  student   Student   @relation(fields: [studentId], references: [id])
  drive     Drive     @relation(fields: [driveId], references: [id])
  status    StageName
  createdAt DateTime  @default(now())

  @@unique([studentId, driveId])
  @@index([driveId])
  @@index([studentId])
}

model DriveStage {
  id        String      @id @default(uuid())
  driveId   String
  collegeId String
  drive     Drive       @relation(fields: [driveId], references: [id])
  college   College     @relation(fields: [collegeId], references: [id])
  stage     StageName
  status    StageStatus
  updatedAt DateTime    @updatedAt

  @@unique([driveId, collegeId, stage])
  @@index([driveId, collegeId])
}

model FileUpload {
  id           String   @id @default(uuid())
  uploaderRole Role
  driveId      String?
  collegeId    String?
  drive        Drive?   @relation(fields: [driveId], references: [id])
  college      College? @relation(fields: [collegeId], references: [id])
  fileType     FileType
  fileUrl      String
  fileName     String
  fileSize     Int
  mimeType     String
  uploadedByUserId String
  uploadedBy   User     @relation(fields: [uploadedByUserId], references: [id])
  createdAt    DateTime @default(now())

  @@index([driveId])
  @@index([collegeId])
  @@index([uploadedByUserId])
}

model AuditLog {
  id        String   @id @default(uuid())
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id])
  action    String
  entity    String
  entityId  String
  createdAt DateTime @default(now())

  @@index([actorId])
}
