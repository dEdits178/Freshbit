generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  COMPANY
  COLLEGE
  ADMIN
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum DriveStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum StageName {
  APPLICATIONS
  TEST
  SHORTLIST
  INTERVIEW
  FINAL
}

enum StageStatus {
  PENDING
  ACTIVE
  COMPLETED
}

enum FileType {
  JD
  STUDENT_LIST
  SHORTLIST
  FINAL_LIST
}

enum ApplicationStatus {
  APPLIED
  IN_TEST
  SHORTLISTED
  IN_INTERVIEW
  SELECTED
  REJECTED
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum ManagedBy {
  COLLEGE
  ADMIN
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  role      Role
  status    UserStatus
  verified  Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  company   Company?   @relation("UserCompany")
  college   College?   @relation("UserCollege")
  auditLogs AuditLog[]
  fileUploadsUploaded FileUpload[]
}

model Company {
  id        String   @id @default(uuid())
  name      String
  domain    String
  approved  Boolean
  userId    String   @unique
  user      User     @relation("UserCompany", fields: [userId], references: [id])
  drives    Drive[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model College {
  id            String         @id @default(uuid())
  name          String
  city          String
  state         String
  tier          String
  approved      Boolean
  userId        String         @unique
  user          User           @relation("UserCollege", fields: [userId], references: [id])
  driveColleges DriveCollege[]
  students      Student[]
  fileUploads   FileUpload[]
  driveStudents DriveStudent[]
  applications  Application[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Drive {
  id            String         @id @default(uuid())
  companyId     String
  company       Company        @relation(fields: [companyId], references: [id])
  roleTitle     String
  salary        Int
  description   String
  status        DriveStatus
  currentStage  String
  isLocked      Boolean        @default(false)
  lockedAt      DateTime?
  jdFileUrl     String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  driveColleges DriveCollege[]
  applications  Application[]
  stages        Stage[]
  fileUploads   FileUpload[]
  driveStudents DriveStudent[]

  @@index([companyId])
  @@index([status])
}

model DriveCollege {
  id               String             @id @default(uuid())
  driveId          String
  collegeId        String
  invitationStatus InvitationStatus   @default(PENDING)
  managedBy        ManagedBy?
  startedAt        DateTime?
  isLocked         Boolean            @default(false)
  completedAt      DateTime?
  currentStage     String             @default("APPLICATIONS")
  stageHistory     Json?
  drive            Drive              @relation(fields: [driveId], references: [id])
  college          College            @relation(fields: [collegeId], references: [id])
  stageProgress    DriveCollegeStage[]
  uploadLogs       DriveCollegeUpload[]
  createdAt        DateTime           @default(now())

  @@unique([driveId, collegeId])
  @@index([driveId])
  @@index([collegeId])
}

model DriveCollegeStage {
  id              String        @id @default(uuid())
  driveCollegeId  String
  name            StageName
  order           Int
  status          StageStatus   @default(PENDING)
  startedAt       DateTime?
  completedAt     DateTime?
  completedBy     String?
  driveCollege    DriveCollege @relation(fields: [driveCollegeId], references: [id], onDelete: Cascade)

  @@unique([driveCollegeId, name])
  @@index([driveCollegeId])
}

model DriveCollegeUpload {
  id             String      @id @default(uuid())
  driveCollegeId String
  stage          String
  fileName       String
  fileType       String
  totalRecords   Int
  validRecords   Int
  invalidRecords Int
  uploadedBy     String
  uploadedAt     DateTime    @default(now())
  driveCollege   DriveCollege @relation(fields: [driveCollegeId], references: [id], onDelete: Cascade)

  @@index([driveCollegeId])
}

model Student {
  id           String        @id @default(uuid())
  firstName    String
  lastName     String
  email        String
  phone        String?
  course       String?
  cgpa         Float?
  collegeId    String
  college      College       @relation(fields: [collegeId], references: [id])
  driveLinks   DriveStudent[]
  applications Application[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([email, collegeId])
  @@index([collegeId])
}

model DriveStudent {
  id               String   @id @default(uuid())
  driveId          String
  studentId        String
  collegeId        String
  drive            Drive    @relation(fields: [driveId], references: [id], onDelete: Cascade)
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  college          College  @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())

  @@unique([driveId, studentId])
  @@index([driveId])
  @@index([collegeId])
}

model Application {
  id            String   @id @default(uuid())
  driveId       String
  studentId     String
  collegeId     String
  
  status        ApplicationStatus @default(APPLIED)
  currentStage  String   @default("APPLICATIONS")
  selectedAt    DateTime?
  rejectedAt    DateTime?
  stageHistory  Json?
  appliedAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  drive         Drive    @relation(fields: [driveId], references: [id], onDelete: Cascade)
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  college       College  @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  
  @@unique([driveId, studentId])
  @@index([driveId])
  @@index([studentId])
}

model Stage {
  id          String      @id @default(uuid())
  driveId     String
  drive       Drive       @relation(fields: [driveId], references: [id], onDelete: Cascade)
  name        StageName
  order       Int
  status      StageStatus
  startedAt   DateTime?
  completedAt DateTime?
}

model FileUpload {
  id           String   @id @default(uuid())
  uploaderRole Role
  driveId      String?
  collegeId    String?
  drive        Drive?   @relation(fields: [driveId], references: [id])
  college      College? @relation(fields: [collegeId], references: [id])
  fileType     FileType
  fileUrl      String
  fileName     String
  fileSize     Int
  mimeType     String
  uploadedByUserId String
  uploadedBy   User     @relation(fields: [uploadedByUserId], references: [id])
  createdAt    DateTime @default(now())

  @@index([driveId])
  @@index([collegeId])
  @@index([uploadedByUserId])
}

model AuditLog {
  id        String   @id @default(uuid())
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id])
  action    String
  entity    String
  entityId  String
  createdAt DateTime @default(now())

  @@index([actorId])
}
