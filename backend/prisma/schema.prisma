generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  COMPANY
  COLLEGE
  ADMIN
}

enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum DriveStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum StageType {
  APPLICATIONS
  TEST
  SHORTLIST
  INTERVIEW
  FINAL
}

enum StageStatus {
  PENDING
  ACTIVE
  COMPLETED
}

enum FileType {
  JD
  STUDENT_LIST
  SHORTLIST
  FINAL_LIST
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum ManagedBy {
  COLLEGE
  ADMIN
}

enum ApplicationStatus {
  APPLIED
  IN_TEST
  SHORTLISTED
  IN_INTERVIEW
  SELECTED
  REJECTED
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  role      Role
  status    UserStatus
  verified  Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  company   Company?   @relation("UserCompany")
  college   College?   @relation("UserCollege")
  auditLogs AuditLog[]
  fileUploadsUploaded FileUpload[]
}

model Company {
  id        String   @id @default(uuid())
  name      String
  domain    String
  approved  Boolean
  userId    String   @unique
  user      User     @relation("UserCompany", fields: [userId], references: [id])
  drives    Drive[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model College {
  id            String         @id @default(uuid())
  name          String
  city          String
  state         String
  tier          String
  approved      Boolean
  userId        String         @unique
  user          User           @relation("UserCollege", fields: [userId], references: [id])
  driveColleges DriveCollege[]
  students      Student[]
  fileUploads   FileUpload[]
  driveStudents DriveStudent[]
  applications Application[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Drive {
  id            String         @id @default(uuid())
  companyId     String
  company       Company        @relation(fields: [companyId], references: [id])
  roleTitle     String
  salary        Int
  description   String
  status        DriveStatus
  jdFileUrl     String?
  currentStage  StageType       @default(APPLICATIONS)
  isLocked      Boolean         @default(false)
  lockedAt      DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  driveColleges DriveCollege[]
  applications  Application[]
  stages        Stage[]
  fileUploads   FileUpload[]
  driveStudents DriveStudent[]
  
  @@index([companyId])
  @@index([status])
}

model DriveCollege {
  id               String           @id @default(uuid())
  driveId          String
  collegeId        String
  invitationStatus InvitationStatus @default(PENDING)
  managedBy        ManagedBy?
  startedAt        DateTime?
  studentsUploaded Boolean          @default(false)
  studentCount     Int              @default(0)
  shortlistSubmitted       Boolean  @default(false)
  shortlistSubmittedAt     DateTime?
  interviewListSubmitted   Boolean  @default(false)
  interviewListSubmittedAt DateTime?
  finalized                Boolean  @default(false)
  finalizedAt              DateTime?
  finalizedBy              String?
  shortlistedCount         Int      @default(0)
  interviewedCount         Int      @default(0)
  selectedCount            Int      @default(0)
  drive            Drive            @relation(fields: [driveId], references: [id])
  college          College          @relation(fields: [collegeId], references: [id])
  createdAt        DateTime         @default(now())
  
  @@unique([driveId, collegeId])
  @@index([driveId])
  @@index([collegeId])
}

model Student {
  id           String        @id @default(uuid())
  firstName    String
  lastName     String
  email        String
  phone        String?
  course       String?
  cgpa         Float?
  collegeId    String
  college      College       @relation(fields: [collegeId], references: [id])
  driveLinks   DriveStudent[]
  applications Application[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  @@unique([email, collegeId])
  @@index([collegeId])
}

model DriveStudent {
  id               String   @id @default(uuid())
  driveId          String
  studentId        String
  collegeId        String
  applicationId    String?   @unique
  application      Application? @relation(fields: [applicationId], references: [id])
  drive            Drive    @relation(fields: [driveId], references: [id], onDelete: Cascade)
  student          Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  college          College  @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())
  
  @@unique([driveId, studentId])
  @@index([driveId])
  @@index([collegeId])
}

model Application {
  id            String   @id @default(uuid())
  driveId       String
  studentId     String
  collegeId     String
  
  // Current status in pipeline
  status        ApplicationStatus @default(APPLIED)
  
  // Stage tracking
  currentStage  StageType @default(APPLICATIONS)
  stageHistory  Json?
  shortlistedAt DateTime?
  shortlistedBy String?
  interviewedAt DateTime?
  interviewedBy String?
  selectedBy    String?
  rejectedAt    DateTime?
  rejectedBy    String?
  selectedAt    DateTime?
  
  // Metadata
  appliedAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  drive         Drive    @relation(fields: [driveId], references: [id], onDelete: Cascade)
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  college       College  @relation(fields: [collegeId], references: [id], onDelete: Cascade)
  driveStudents DriveStudent[]
  
  @@unique([driveId, studentId])
  @@index([driveId])
  @@index([studentId])
  @@index([collegeId])
  @@index([status])
  @@index([currentStage])
}

model Stage {
  id          String      @id @default(uuid())
  driveId     String
  name        StageType
  status      StageStatus @default(PENDING)
  order       Int
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  drive       Drive       @relation(fields: [driveId], references: [id], onDelete: Cascade)

  @@unique([driveId, name])
  @@index([driveId])
  @@index([status])
}

model FileUpload {
  id           String   @id @default(uuid())
  uploaderRole Role
  driveId      String?
  collegeId    String?
  drive        Drive?   @relation(fields: [driveId], references: [id])
  college      College? @relation(fields: [collegeId], references: [id])
  fileType     FileType
  fileUrl      String
  fileName     String
  fileSize     Int
  mimeType     String
  uploadedByUserId String
  uploadedBy   User     @relation(fields: [uploadedByUserId], references: [id])
  createdAt    DateTime @default(now())
  
  @@index([driveId])
  @@index([collegeId])
  @@index([uploadedByUserId])
}

model AuditLog {
  id        String   @id @default(uuid())
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id])
  action    String
  entity    String
  entityId  String
  createdAt DateTime @default(now())
  
  @@index([actorId])
}
